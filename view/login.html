<!DOCTYPE html>
<html lang="en">

<head>
    <title>Login - Cygnus NVR</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/res/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/res/apple-touch-icon-144x144.png">
    <link rel="icon" type="image/png" href="/res/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/res/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/x-icon" href="/res/favicon.ico">

    <link href="/css/fontawesome.min.css" rel="stylesheet">
    <link href="/css/stylesheet.css" rel="stylesheet">
    <link href="/css/cygnus-dialog.css" rel="stylesheet">

    <script src="/js/vue.min.js"></script>
</head>

<body>
    <div class="login" id="app">
        <p class="error-message" v-if="error !== ''">{{error}}</p>
        <div id="login-box">
            <div id="logo-area">
                <img src="/res/logo.svg">
                <p id="tagline"><b>Cygnus</b>, simple, secure (?) camera</p>
            </div>
            <div id="input-area">
                <label for="username">Username: </label>
                <input type="text" name="username" v-model.trim="username" placeholder="Username" tabindex="1">
                <label for="password">Password: </label>
                <input type="password" name="password" v-model.trim="password" placeholder="Password" tabindex="2" @keyup.enter="login">
                <label class="checkbox-field"><input type="checkbox" name="remember" v-model="remember" tabindex="3">Remember me</label>
            </div>
            <div id="button-area">
                <a v-if="loading">
                    <i class="fas fa-fw fa-spinner fa-spin"></i>
                </a>
                <a v-else class="button" tabindex="4" @click="login" @keyup.enter="login">Log In</a>
            </div>
        </div>
    </div>

    <script type="module">
        var app = new Vue({
            el: "#app",
            data: {
                error: "",
                loading: false,
                username: "",
                password: "",
                remember: false,
            },
            methods: {
                login() {
                    // Validate input
                    if (this.username === "") {
                        this.error = "Username must not empty";
                        return;
                    }

                    // Remove old cookie
                    document.cookie = "session-id=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
                    
                    // Send request
                    this.loading = true;
                    fetch("/api/login", {
                            method: "post",
                            credentials: "include",
                            body: JSON.stringify({
                                username: this.username,
                                password: this.password,
                                remember: this.remember ? 12 : 1,
                            }),
                            headers: {
                                "Content-Type": "application/json",
                            },
                        })
                        .then(response => {
                            if (!response.ok) throw response;
                            return response;
                        })
                        .then(() => {
                            location.href = "/";
                        })
                        .catch(err => {
                            this.loading = false;
                            err.text().then(msg => {
                                this.error = `${msg} (${err.status})`;
                            })
                        });
                }
            }
        })
    </script>
</body>

</html>